/*jshint browser:true*/
/*global Namespace:false*/
Namespace('jp.mixi.service.analysis')
.use('jp.co.mixi.gateway gateway')
.use('jp.co.mixi.lang parseIntAsDecimal')
.use('jp.co.mixi.net.jsonrpc JSONRPC')
.define(function(ns){
    var memberId = ns.parseIntAsDecimal(ns.gateway('login_member_id'));
    var postKey  = ns.gateway('rpc_post_key');

    var SAMPLING_ID = 68;
    var isSamplingId = ((memberId % 100) === SAMPLING_ID);
    var rpc = ns.JSONRPC.createService('/system/rpc.json',{ auth_type : 'postkey', secret : postKey});
    var isDebug   = ns.gateway('RUN_MODE') == 'debug';
    var isStaging = ns.gateway('RUN_MODE') == 'staging';

    ns.provide({
        postAnalysisLog: function(locationParam){
            if(!locationParam) {
                return;
            }

            if(!isSamplingId && !isDebug) {
                return;
            }

            rpc.call('jp.mixi.analysis.analysisOfClickCount',{
                member_id : memberId,
                location  : locationParam
            }, function() {});
        },
        postUIEventLog: function(eventName, pageName, callback, errorCallback){
            if(!eventName) {
                return;
            }

            rpc.call('jp.mixi.analysis.uievent.send',{
                member_id  : memberId,
                event_name : eventName,
                page_name  : pageName
            }, (callback || function (){}), (errorCallback || function (){}));
        },
        isSamplingIdOnePercent: function(samplingId) {
            var isSampling = ((memberId % 100) === samplingId);
            if(!isSampling && !isDebug && !isStaging) {
                return;
            }
            return true;
        },
        isSamplingIdTenPercent: function(samplingId) {
            var isSampling = ((memberId % 10) === samplingId);
            if(!isSampling && !isDebug && !isStaging) {
                return;
            }
            return true;
        }
    });
});

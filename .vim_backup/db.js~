// db.js
// mysql interface

module.exports = {
    connectDB : function() {
        var mysql = require('mysql');
        var connection = mysql.createConnection({
                host     : 'mysql.lo.mixi.jp',
                user     : 'root',
                password : '',
                database : 'akio_watanabe',
        });
        connection.connect();
        return connection;
    },

    insertDecidedOrder : function(order){
        var connection = connectDB();
        var sql = 'INSERT INTO decided_order (decided_order, created_at) VALUES (?,NOW());';

        var query = connection.query(sql, order);

        query
            .on('error', function(err){
                console.log('err is: ', err );
            })
            .on('result', function(rows){
                console.log('THe res is: ', rows );
            })
            .on('end', function() {
                console.log('end');
                connection.destroy();
            });
    },
    insertAssociation : function(iyadas, category){
        var mysql = require('mysql');
        var connection = mysql.createConnection({
                host     : 'mysql.lo.mixi.jp',
                user     : 'root',
                password : '',
                database : 'akio_watanabe',
        });

        var sql = 'INSERT INTO query_menu_association_proto (query, category) VALUES (?,?) ON DUPLICATE KEY UPDATE click = click+1;';
        var total_sql = 'INSERT INTO query_menu_association_proto (query, category) VALUES (?,"total") ON DUPLICATE KEY UPDATE click = click+1;';

        connection.connect();

        var query = connection.query(sql, [iyadas, category]);
        var total_query = connection.query(total_sql, iyadas);

        query
            .on('error', function(err){
                console.log('err is: ', err );
            })
            .on('result', function(rows){
                console.log('THe res is: ', rows );
            })
            .on('end', function() {
                console.log('end');
                connection.destroy();
            });
        total_query
            .on('error', function(err){
                console.log('err is: ', err );
            })
            .on('result', function(rows){
                console.log('THe res is: ', rows );
            })
            .on('end', function() {
                console.log('end');
                connection.destroy();
            });
    },
    findRestaurant : function( id, callback ){
        var mysql = require('mysql');
        var connection = mysql.createConnection({
                host     : 'mysql.lo.mixi.jp',
                user     : 'root',
                password : '',
                database : 'akio_watanabe',
        });

        var sql = 'SELECT * FROM shop_list_proto WHERE shop_id = ?';

        connection.connect();

        var query = connection.query(sql, id);

        query
            .on('error', function(err){
                console.log('err is: ', err );
            })
            .on('result', function(rows){
                console.log('THe res is: ', rows );
                callback(rows);
            })
            .on('end', function() {
                console.log('end');
                connection.destroy();
            });
    }

};

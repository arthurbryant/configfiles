use strict;
use warnings;
use utf8;

use Mojolicious::Lite;
use DBIx::Simple;

my @dsn = (
    'dbi:mysql:host=dev.mysql.lo.mixi.jp;database=feng_zhang;',
    'root', '', { RaiseError => 1, mysql_enable_utf8 => 1},
);

get '/' => sub {
    my $self = shift;

    my $db = DBIx::Simple->connect(@dsn);
    my $result = $db->query('SELECT id, name, body, created_at FROM entry');

    my @entries = $result->hashes;
    $self->stash(entries => \@entries);

    $self->render(template => 'index');
};

# Display the user's text
post '/user_entries' => sub {
    
    my $self = shift;
    my $MAX = 8;

    my $name = $self->param('name');
    my $body = $self->param('body');

    if($name eq undef || $name eq '') {
        $self->render('error');
        return;
    }
    if($name =~ /\W+/) {
        $self->render('error');
        return;
    }
    if(length($name) > $MAX) {
        $self->render('error');
        return;
    }
    
    my $db = DBIx::Simple->connect(@dsn);
    $db->query('INSERT INTO
                            entry(name, body, created_at)
                        VALUES
                            ( ?, ?, NOW())',
                        $name, $body);
    my $like_name = '%' . $name . '%';
    my $result = $db->query('SELECT id, name, body, created_at FROM entry where name like ?', $like_name);

    my @entries = $result->hashes;
    $self->stash(entries => \@entries);

    $self->render(template => 'index');
    
}; 

post '/entry' => sub {
    my $self = shift;

    my $name = $self->param('name');
    my $body = $self->param('body');

    my $db = DBIx::Simple->connect(@dsn);
    $db->query('INSERT INTO
                            entry(name, body, created_at)
                        VALUES
                            ( ?, ?, NOW())',
                        $name, $body);
    $self->redirect_to('index');
};

post '/edit_entry' => sub {
    
};

app->start;

__DATA__
@@ index.html.ep
<!DOCTYPE html>
<html>
  <head>
  <title>Simple BBS</title>
  <meta charset="utf-8">
  </head>
  <body>
    <h1>Hello My BBS</h1>

    <form method="post" action="/user_entries">
      名前<br />
      <input type="text" name="name" /><br />
      本文<br />
      <textarea name="body" rows="4" cols="50"></textarea><br />
      <br />
      <input type="submit" value="送信する">
    </form>
    <form method='post' action='/edit_entry'>
    <ol>
      <% for my $entry (@$entries) { %>
        <li>
        <input type="checkbox" name="<%= $entry->{id} =%>" value="on"/>
          名前：<%= $entry->{name} =%> <br />
          本文：<%= $entry->{body} =%> <br />
          投稿日時：<%= $entry->{created_at} =%> <br />
        </li>
      <% } %>
        <input type="submit" value="edit">
    </ol>
    </form>
  </body>
</html>
@@ error.html.ep
<!DOCTYPE html>
<html>
  <head>
    <title>Simple BBS</title>
      <meta charset="utf-8">
        </head>
          <body>
              <h1>Error</h1>
                </body>
                </html>
